# ğŸŒ Cross-Repo Index Strategy

**Design Date**: 2026-02-13  
**System**: BlackRoad OS (1,000+ repositories)  
**Scale Target**: 1,000,000+ workflows across distributed repos  

---

## ğŸ¯ The Problem

You have:
- **1,000+ repositories** across 15+ GitHub organizations
- **Workflows** that span multiple repos (e.g., API change â†’ client updates)
- **Multiple agents** working across repo boundaries
- **No centralized monolith** (by design)

**Challenge**: How do workflows discover and reference each other without:
- Creating a single-point-of-failure index
- Requiring every repo to know about every other repo
- Breaking the "index-first, merge-never" philosophy

---

## ğŸ§  Core Insight

**Workflows don't need to know each other. They need to be discoverable.**

Same principle as DNS:
- Domains don't have a master list of all other domains
- But any domain can be found via hierarchical query
- No centralization, infinite scale

---

## ğŸ—ï¸ Architecture: 3-Tier Discovery

### Tier 1: Local Index (Per-Repo)

**Location**: `.blackroad/workflow-index.jsonl` in each repo

**Format** (append-only):
```jsonl
{"id":"WF-20260213-SYS-0001","repo":"BlackRoad-OS/api","title":"Add /health endpoint","state":"Active","scope":"SYS","deps":[],"timestamp":"2026-02-13T15:30:00Z"}
{"id":"SEC-20260213-PUB-0006","repo":"BlackRoad-OS/web","title":"Fix XSS in profile","state":"Active","scope":"PUB","deps":["WF-20260213-SYS-0001"],"timestamp":"2026-02-13T16:45:00Z"}
```

**Properties**:
- Append-only (never edit, only add)
- Small (< 1KB per workflow)
- Machine + human readable
- Git-trackable

**Auto-generated by**: GitHub Action on workflow creation

---

### Tier 2: Organization Index (Per-Org)

**Location**: GitHub Project (like your Project #9)

**Method**: GitHub Actions sync from Tier 1

```yaml
# .github/workflows/sync-to-org-index.yml
name: Sync to Organization Index

on:
  push:
    paths:
      - '.blackroad/workflow-index.jsonl'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Read new workflows
        run: |
          # Parse .blackroad/workflow-index.jsonl
          # Extract new entries (compare to last sync)
          
      - name: Add to GitHub Project
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Add each workflow as project item
          gh project item-add <ORG_PROJECT_NUMBER> --url $ISSUE_URL
```

**Result**:
- Each org has ONE project that aggregates all repo workflows
- No manual syncing required
- Queries work org-wide

---

### Tier 3: Global Discovery (Cross-Org)

**Location**: Central discovery service (optional, for cross-org queries)

**Two approaches**:

#### Approach A: Federated (Recommended)

Each org exposes a **read-only API endpoint**:

```
GET /api/workflows?scope=SYS&state=Active
GET /api/workflows/{id}
GET /api/workflows/dependencies/{id}
```

Implementation options:
- Cloudflare Worker reading GitHub Project via GraphQL
- Railway service with cached index
- GitHub Pages with static JSON (updated hourly)

**Agents query multiple orgs in parallel** when needed.

#### Approach B: Aggregated (If you must)

Single service that polls all org indexes hourly:

```
GET /api/global/workflows?repo=BlackRoad-OS/*
GET /api/global/workflows?scope=SYS&state=Active
```

**Warning**: This creates centralization. Only use if federated queries are too slow.

---

## ğŸ”— Workflow Dependencies (The Hard Part)

### Dependency Format

In workflow metadata:
```json
{
  "id": "WF-20260213-SVC-0005",
  "deps": [
    "WF-20260212-SYS-0001",           // Same repo
    "BlackRoad-OS/api#SEC-20260213-PUB-0006",  // Different repo (explicit)
    "^WF-20260210-SYS-0003"           // Soft dependency (optional)
  ]
}
```

**Notation**:
- `WF-XXXX-XXX-XXXX` = Same repo (local)
- `org/repo#WF-XXXX-XXX-XXXX` = Cross-repo (explicit)
- `^WF-XXXX-XXX-XXXX` = Soft dependency (won't block)

### Dependency Discovery

**GitHub Action**: `check-dependencies.yml`

```yaml
name: Check Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Query all dependencies
        run: |
          # For each workflow in this repo:
          # 1. Parse deps from .blackroad/workflow-index.jsonl
          # 2. For cross-repo deps, query Tier 2 index
          # 3. Check if dep is Done/Blocked/Active
          # 4. Update traffic light if needed
          
      - name: Create alerts
        if: blocked_deps_found
        run: |
          # Create issue: "âš ï¸ Blocked: WF-20260213-SVC-0005 waiting on org/repo#WF-..."
```

---

## ğŸ¨ Query Patterns

### Pattern 1: "What's blocking me?"

**Local repo query**:
```bash
# Check dependencies of current workflow
grep "WF-20260213-SVC-0005" .blackroad/workflow-index.jsonl | \
  jq -r '.deps[]' | \
  while read dep; do
    # If cross-repo, query Tier 2
    # Otherwise, check local
  done
```

**Result**: List of incomplete dependencies

---

### Pattern 2: "Who depends on me?"

**Reverse dependency query** (Tier 2):

```graphql
query {
  organization(login: "BlackRoad-OS") {
    projectV2(number: 9) {
      items(first: 100, 
            filterBy: {fieldName: "Dependencies", 
                      contains: "WF-20260213-SYS-0001"}) {
        nodes {
          content {
            ... on Issue {
              title
              url
            }
          }
        }
      }
    }
  }
}
```

**Result**: All workflows depending on you

---

### Pattern 3: "Show all System-scope Active workflows across all repos"

**Org-wide query** (Tier 2):

```bash
gh project item-list <ORG_PROJECT_NUMBER> \
  --format json \
  --jq '.items[] | select(.state=="Active" and .scope=="SYS")'
```

**Result**: Cross-repo view without centralization

---

### Pattern 4: "Has anyone solved this problem before?"

**Content search** (GitHub Code Search):

```bash
gh search code \
  --org BlackRoad-OS \
  "XSS sanitization" \
  --extension md \
  --path .blackroad/
```

**Result**: Find similar workflows by description

---

## ğŸ¤– Multi-Agent Coordination

### Agent Discovery Protocol

**Each agent checks before starting work**:

1. **Query local repo** (Tier 1):
   ```bash
   grep -i "user avatar" .blackroad/workflow-index.jsonl
   ```
   
2. **Query org index** (Tier 2) if nothing found:
   ```bash
   gh project item-list 9 --format json | \
     jq '.items[] | select(.title | test("avatar"; "i"))'
   ```

3. **Check traffic lights**:
   - If ğŸ”´ Red found â†’ coordinate first
   - If ğŸŸ¡ Yellow found â†’ read provenance, decide if safe
   - If ğŸŸ¢ Green or nothing â†’ proceed

4. **Create workflow** with coordination metadata:
   ```json
   {
     "id": "WF-20260213-SVC-0007",
     "title": "User avatar upload",
     "traffic_light": "ğŸŸ¢",
     "related": ["WF-20260210-SVC-0003"],  // Similar work (FYI only)
     "agent": "Copilot-Session-52728b0b"
   }
   ```

### Collision Avoidance

**Traffic light auto-promotion**:

```yaml
# .github/workflows/traffic-light-auto.yml
on:
  issues:
    types: [opened, edited]

jobs:
  check:
    steps:
      - name: Detect potential conflicts
        run: |
          # If new workflow has same Service + Intent as existing Active workflow:
          # â†’ Auto-set to ğŸŸ¡ Yellow
          # â†’ Comment: "âš ï¸ Similar work detected: WF-XXXX-XXX-XXXX"
```

---

## ğŸ“Š Scaling Strategy

### At 100 repos, 10K workflows:
- **Tier 1**: Works perfectly (local indexes tiny)
- **Tier 2**: One project per org, fast queries
- **Tier 3**: Not needed yet

### At 1,000 repos, 100K workflows:
- **Tier 1**: Still works (JSONL is efficient)
- **Tier 2**: May need pagination (100 items at a time)
- **Tier 3**: Add read-only API for cross-org queries

### At 10,000 repos, 1M workflows:
- **Tier 1**: Still works (Git handles it)
- **Tier 2**: Multiple projects per org (by domain/service)
- **Tier 3**: Federated discovery required (each org exposes API)

### At 100,000 repos, 10M workflows:
- **Tier 1**: Still works (append-only scales linearly)
- **Tier 2**: Sharded projects (time-based or service-based)
- **Tier 3**: Content-addressed discovery (DHT-style)

**Key insight**: The system never breaks. It just adds layers.

---

## ğŸ› ï¸ Implementation Checklist

### Phase 1: Local Indexes (Week 1)
- [ ] Create `workflow-index-sync.yml` action
- [ ] Add to template repo
- [ ] Deploy to 10 test repos
- [ ] Verify JSONL generation

### Phase 2: Org Aggregation (Week 2)
- [ ] Set up Tier 2 projects (one per org)
- [ ] Create `sync-to-org-index.yml` action
- [ ] Test cross-repo queries
- [ ] Document query patterns

### Phase 3: Dependency Tracking (Week 3)
- [ ] Add `deps` field to workflow metadata
- [ ] Create `check-dependencies.yml` action
- [ ] Build dependency visualization
- [ ] Test blocked workflow alerts

### Phase 4: Global Discovery (Week 4)
- [ ] Choose federated vs aggregated approach
- [ ] Implement read-only API (Cloudflare Worker?)
- [ ] Add cross-org query examples
- [ ] Load test with 1K workflows

### Phase 5: Agent Integration (Week 5)
- [ ] Update agent protocols to check indexes
- [ ] Add auto-traffic-light detection
- [ ] Test multi-agent collision avoidance
- [ ] Create agent coordination dashboard

---

## ğŸ“ File Structure

Across all repos:

```
your-repo/
â”œâ”€â”€ .blackroad/
â”‚   â”œâ”€â”€ workflow-index.jsonl          # Tier 1 (auto-generated)
â”‚   â”œâ”€â”€ workflow-index-schema.json    # Validation schema
â”‚   â””â”€â”€ last-sync.txt                 # Sync tracking
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ workflow-index-sync.yml   # Generate Tier 1 index
â”‚       â”œâ”€â”€ sync-to-org-index.yml     # Push to Tier 2
â”‚       â””â”€â”€ check-dependencies.yml    # Dependency monitoring
â””â”€â”€ README.md
```

Organization-wide:
```
BlackRoad-OS/
â”œâ”€â”€ Project #9 "Template"             # Tier 2 index
â”œâ”€â”€ Project #10 "Active Work"         # Tier 2 filtered view
â””â”€â”€ workflows-api/                    # Tier 3 (optional)
    â””â”€â”€ worker.js                     # Cloudflare Worker
```

---

## ğŸ¯ Success Metrics

**Week 1**:
- 10 repos with Tier 1 indexes
- 100% automated index generation

**Month 1**:
- 100 repos indexed
- <1s query time for org-wide searches
- 0 manual index updates

**Quarter 1**:
- 500+ repos indexed
- Cross-repo dependency tracking working
- 10+ agents using indexes for coordination

**Year 1**:
- 1,000+ repos indexed
- 100K+ workflows tracked
- Global discovery API serving 1M+ queries/month

---

## ğŸš¨ Anti-Patterns (Don't Do This)

âŒ **Monolith Index**: Single repo with all workflows  
âœ… **Distributed Indexes**: Each repo maintains its own

âŒ **Synchronous Sync**: Wait for index update before proceeding  
âœ… **Async Sync**: Work continues, index updates in background

âŒ **Manual Cross-Refs**: Humans maintain dependency links  
âœ… **Auto-Discovery**: Actions detect and track dependencies

âŒ **Required Dependencies**: Block all work until deps clear  
âœ… **Soft Dependencies**: Mark related work, don't block

âŒ **Centralized Decision**: One service decides conflicts  
âœ… **Federated Decision**: Each repo/agent decides locally

---

## ğŸ§ª Test Scenarios

### Scenario 1: Agent Coordination

**Setup**:
- Agent A in `api` repo starts: "Add /health endpoint"
- Agent B in `web` repo starts: "Add health check UI"

**Expected**:
- Agent A creates `WF-20260213-SYS-0001` with ğŸŸ¢ Green
- Agent B queries org index, finds related work
- Agent B creates `WF-20260213-SVC-0005` with dep on SYS-0001
- Agent B sets ğŸŸ¡ Yellow, coordinates with Agent A

### Scenario 2: Cross-Repo Breakage Detection

**Setup**:
- Workflow `SEC-20260213-PUB-0006` (security fix) is deployed
- 5 other repos depend on affected API

**Expected**:
- `check-dependencies.yml` runs in all 5 repos
- Detects breaking change via API contract diff
- Creates alert issues with ğŸ”´ Red traffic light
- Blocks deployment until dependents updated

### Scenario 3: Historical Discovery

**Setup**:
- New agent asks: "Has anyone implemented OAuth before?"

**Expected**:
- Agent searches: `gh search code "OAuth" --org BlackRoad-OS --path .blackroad/`
- Finds 3 previous workflows with OAuth
- Reads provenance to understand decisions
- Reuses learnings, doesn't duplicate work

---

## ğŸ”® Future Extensions

### Content-Addressed Workflows

Instead of:
```
WF-20260213-SYS-0001
```

Use:
```
WF-20260213-SYS-0001-8f3a9c2e  # Last 8 chars of content hash
```

**Benefits**:
- Detect duplicate work automatically
- Verify workflow integrity
- Enable content-based discovery

### Workflow Snapshots

```
.blackroad/snapshots/WF-20260213-SYS-0001/
â”œâ”€â”€ v1.json     # Initial version
â”œâ”€â”€ v2.json     # After first update
â””â”€â”€ v3.json     # Current state
```

**Benefits**:
- Time-travel debugging
- Audit trail
- Rollback capability

### Distributed Hash Table (DHT)

For 10M+ workflows:
- Each repo is a DHT node
- Workflows are content-addressed
- Discovery via Kademlia-style routing
- No centralization at all

---

## ğŸ“š Reference Implementation

**Starter template** (ready to deploy):

```bash
# Add to any repo
curl -o .github/workflows/workflow-index-sync.yml \
  https://raw.githubusercontent.com/BlackRoad-OS/templates/main/workflow-index-sync.yml

# Generate first index
gh workflow run workflow-index-sync.yml

# Verify
cat .blackroad/workflow-index.jsonl
```

---

## ğŸ“ Key Learnings

1. **Indexes beat monoliths** at scale
2. **Local-first, sync later** prevents bottlenecks
3. **Soft dependencies** > hard dependencies
4. **Discovery** > directories
5. **Append-only logs** scale forever

---

## ğŸš€ Next Steps

Choose implementation speed:

**ğŸƒ Fast Track (1 week)**:
- Tier 1 only (local indexes)
- Manual cross-repo coordination
- Good for 100 repos, 10K workflows

**ğŸš¶ Standard Track (1 month)**:
- Tier 1 + Tier 2 (org aggregation)
- Automated dependency tracking
- Good for 1,000 repos, 100K workflows

**ğŸ§˜ Future-Proof Track (1 quarter)**:
- All 3 tiers + agent integration
- Global discovery API
- Good for 10,000+ repos, 1M+ workflows

---

**Status**: Ready to implement  
**Risk**: Low (all components proven)  
**Effort**: Medium (automation-heavy)  
**Impact**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ (unlocks true scale)

---

This is how you coordinate 1,000,000 workflows without a monolith.

**We don't merge reality. We index it.**
